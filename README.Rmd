---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

```{r gh.url, echo=FALSE}
ghurl <- function(x) {
  x <- unlist(x = strsplit(x = x, split = ','))
  x <- trimws(x = x)
  x <- grep(pattern = "https://github.com", x = x, value = TRUE)[1]
  return(unname(obj = x))
}
```

```{r cran.cannoncial, echo=FALSE}
cran.cannoncial <- "https://cran.r-project.org/package="
```

```{r parse.description, echo=FALSE}
description <- read.dcf(file = "DESCRIPTION")
# Get package name
pkg <- as.vector(x = description[, "Package"])
# Get GitHub URL
github.url <- ghurl(x = description[, "URL"])
# Get depedencies
deps <- as.vector(x = description[, c("Depends", "Imports")])
deps <- unlist(x = strsplit(x = deps, split = "\n"))
deps <- vapply(
  X = deps,
  FUN = function(x) {
    return(unlist(x = strsplit(x = x, split = "(", fixed = TRUE))[1])
  },
  FUN.VALUE = character(length = 1L),
  USE.NAMES = FALSE
)
deps <- trimws(x = deps)
deps <- gsub(pattern = ",$", replacement = "", x = deps)
deps <- deps[deps != "R"]
```

```{r parse.version, echo=FALSE}
pkg.version <- package_version(x = description[1, 'Version'])
stage <- if (pkg.version >= package_version(x = "1.0.0")) {
  "stable"
} else if (pkg.version >= package_version(x = "0.1.0")) {
  "maturing"
} else {
  "experimental"
}
color <- c("experimental" = "orange", "maturing" = "blue", "stable" = "brightgreen")[stage]
```

```{r launchcmd, echo=FALSE}
launchcmd <- function(...) {
  args <- c(...)
  return(paste0(
    pkg,
    "::AzimuthApp(",
    paste(args, collapse = ","),
    ")"
  ))
}
```

```{r mdemit, echo=FALSE}
mdemit <- function(..., highlight = "r") {
  ticks <- "```"
  return(paste(
    paste0(ticks, highlight),
    ...,
    ticks,
    sep = "\n"
  ))
}
```

# `r pkg` v`r pkg.version`

<!-- badges: start -->
[![Lifecycle](https://img.shields.io/badge/lifecycle-`r stage`-`r color`.svg)](`r github.url`)
<!-- badges: end -->

`r pkg` is a Shiny app demonstrating a query-reference mapping algorithm for single-cell data. The reference data accompanying the app and the algorithms used are described [in our publication](Seurat 4 biorxiv link).

We have made an instance of the app available for public use, [available here](app landing page on lab website).

All the analysis and visualization functionality available in the app - and much more - is available in [version 4 of the the Seurat R package](Seurat4 landing page on lab website).

## Installation

You can install `r pkg` from GitHub with:

```{r devel.install, echo=FALSE, results="asis"}
github.base <- unlist(x = strsplit(x = github.url, split = "/"))
github.base <- paste(rev(x = rev(x = github.base)[1:2]), collapse = "/")
cat(
  "```r",
  "if (!requireNamespace('remotes', quietly = TRUE) {",
  "  install.packages('remotes')",
  "}",
  paste0("remotes::install_github('", github.base, "', ref = 'master')"),
  "```",
  sep = "\n"
)
```

## Running the app

The app is launched as:

```{r launch, echo=FALSE, results="asis"}
cat(mdemit(launchcmd()))
```

By default, the appropriate reference files are loaded into memory by accessing a web URL. If you instead have a directory containing reference files at `/path/to/reference`, specify it as:

```{r launch.ref, echo=FALSE, results="asis"}
cat(mdemit(launchcmd("reference = '/path/to/reference'")))
```

### Specifying options

You can set options by passing a parameter to the `AzimuthApp` function:

```{r launch.param, echo=FALSE, results="asis"}
cat(mdemit(launchcmd("maxcells = 100000")))
```

or setting the option in R (e.g. if it is not a parameter to the `AzimuthApp` function):

```{r launch.opt, echo=FALSE, results="asis"}
cat(mdemit("options('Azimuth.map.pbcorthresh' = 0.5)", launchcmd()))
```

## Docker

First, build the Docker image. Clone the repository and run the following while in the root of the repository to build the image and tag it with the name "seurat-mapper":

```
docker build -t seurat-mapper .
```

Next, launch a container based on the image `seurat-mapper` with a bind mount mounting the directory on the host containing the reference files (e.g. `/path/to/reference`) as `/reference-data` in the container.

```
docker run -it -p 3838:3838 -v /path/to/reference:/reference-data:ro seurat-mapper
```

If port 3838 is already in use on the host or you wish to use a different port, use `-p NNNN:3838` in the run command instead, to bind port NNNN on the host to port 3838 on the container.
The container runs the command `R -e "Azimuth::AzimuthApp(reference = '/reference-data')"` by default.

### Specifying options

You can set options by passing a parameter to the `AzimuthApp` function:

```
docker run -it -p 3838:3838 -v /path/to/reference:/reference-data:ro seurat-mapper R -e "Azimuth::AzimuthApp(reference = '/reference-data', max.cells = 100000)"
```

or setting the option in R (e.g. if it is not a parameter to the `AzimuthApp` function):

```
docker run -it -p 3838:3838 -v /path/to/reference:/reference-data:ro seurat-mapper R -e "options('Azimuth.map.pbcorthresh' = 0.5)" -e "Azimuth::AzimuthApp(reference = '/reference-data')"
```

or just starting a shell in the container, from which you can launch an interactive R session and set options as desired:

```
docker run -it -p 3838:3838 -v /path/to/reference:/reference-data:ro seurat-mapper /bin/bash
```


## Run asynchronous mapping score

If the app is launched in an environment with `future::plan('multicore', workers = 2)`, the mapping score will continue to compute in the background once the visualizations become available. Please note: This feature is unavailable when running in Rstudio, and we have observed that it may not work as intended on Mac OS.


## Support

We do not actively support users running the app themselves and suggest you use [version 4 of the Seurat package](Seurat4 landing page on lab website) to run the reference mapping workflow and related visualizations on your local system. Please see the [Seurat mapping vignette](link to vignette) for an example of how to use Seurat for reference mapping. If you use the instance of the app we are hosting on the web, you can download a Seurat v4 R script once your analysis is complete that will guide you in reproducing the analysis. You do not need seurat-mapper to reproduce the analysis.

If you would like to help us improve the app, and you believe a dataset meets the requirements and it is publicly available for us to use for debugging but the app doesnâ€™t work, please file a Github issue linking to the dataset and describing the problem on [the issues page](app repository issue page). 

